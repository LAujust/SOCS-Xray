

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOCS_Xray.fetch &mdash; SOCS_Xray  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SOCS_Xray
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Example Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data.html">Fetch Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SOCS_Xray</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">SOCS_Xray.fetch</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for SOCS_Xray.fetch</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">alerce.core</span> <span class="kn">import</span> <span class="n">Alerce</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">lasair</span> <span class="kn">import</span> <span class="n">LasairError</span><span class="p">,</span> <span class="n">lasair_client</span> <span class="k">as</span> <span class="n">lasair</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">playwright.sync_api</span> <span class="kn">import</span> <span class="n">sync_playwright</span><span class="p">,</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">PWTimeout</span>
<span class="kn">import</span> <span class="nn">pexpect</span>



<div class="viewcode-block" id="update_WXT_source_list">
<a class="viewcode-back" href="../../api.html#SOCS_Xray.fetch.update_WXT_source_list">[docs]</a>
<span class="k">def</span> <span class="nf">update_WXT_source_list</span><span class="p">(</span><span class="n">EMAIL</span><span class="p">,</span><span class="n">PASSWORD</span><span class="p">,</span><span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download WXT source list.</span>

<span class="sd">    Args:</span>
<span class="sd">        EMAIL (str): user email</span>
<span class="sd">        PASSWORD (str): password</span>
<span class="sd">        save_dir (str, optional): Saving path. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Table: A Table of all sources detected by EP</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Initialization</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://ep.bao.ac.cn/ep/api/get_tokenp&quot;</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="s2">&quot;https://ep.bao.ac.cn/ep/data_center/api/identified_source_list&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">EMAIL</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">PASSWORD</span><span class="p">},</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
            <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  
    <span class="n">token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">)</span> 
    <span class="c1"># print(token) # the token will never expire</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">api_url</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tdic-token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">},</span>  
                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span><span class="n">token</span><span class="p">}</span> <span class="c1">#both hearders and params are need</span>
            <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>  <span class="c1">#convert list elements to string</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
            <span class="n">table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span>
            
            
    <span class="c1">#==== Add Stellar Flare List ===</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="s2">&quot;https://ep.bao.ac.cn/ep/data_center/api/stellar_flare_list&quot;</span>
    <span class="c1">#######</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">EMAIL</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">PASSWORD</span><span class="p">},</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
            <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  
    <span class="n">token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">)</span> 
    <span class="c1"># print(token) # the token will never expire</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">api_url</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tdic-token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">},</span>  
                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span><span class="n">token</span><span class="p">}</span> <span class="c1">#both hearders and params are need</span>
            <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="c1">#data = response.json()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">table_star</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_star</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>  <span class="c1">#convert list elements to string</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">table_star</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
            <span class="n">table_star</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">table_star</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span>
            
    <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
        <span class="n">table_star</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_star</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        
    <span class="n">table</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">((</span><span class="n">table</span><span class="p">,</span><span class="n">table_star</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
        <span class="n">table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span><span class="s1">&#39;EP_identified_source_list.csv&#39;</span><span class="p">),</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has been UPDATED at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;EP_identified_source_list.csv&#39;</span><span class="p">,</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">table</span></div>


<div class="viewcode-block" id="get_TNS">
<a class="viewcode-back" href="../../api.html#SOCS_Xray.fetch.get_TNS">[docs]</a>
<span class="k">def</span> <span class="nf">get_TNS</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;tns_public_objects.csv.zip&#39;</span><span class="p">,</span><span class="n">save_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download TNS object list.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">    filename (str): saved filename</span>
<span class="sd">    save_dir (str): saving path.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    Table: Table of TNS public objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">API_KEY</span> <span class="o">=</span> <span class="s1">&#39;48aa6e2dfcb5893b987dda29b3f3938e97e8db43&#39;</span>
    <span class="n">BOT_ID</span> <span class="o">=</span> <span class="s1">&#39;164028&#39;</span>
    <span class="n">BOT_NAME</span> <span class="o">=</span> <span class="s1">&#39;bot_BC&#39;</span>

    <span class="c1"># API_KEY = &#39;1745589895680b9687d5d2a9.98026628&#39;</span>
    <span class="c1"># BOT_ID = &#39;197764&#39;</span>
    <span class="c1"># BOT_NAME = &#39;EP_bot_lrd&#39;</span>

    <span class="c1"># The base URL for the TNS public objects CSV files</span>
    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://www.wis-tns.org/system/files/tns_public_objects/&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to download a file from a given URL.&quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;user-agent&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;tns_marker</span><span class="se">{{</span><span class="s1">&quot;tns_id&quot;:</span><span class="si">{</span><span class="n">BOT_ID</span><span class="si">}</span><span class="s1">,&quot;type&quot;:&quot;bot&quot;,&quot;name&quot;:&quot;</span><span class="si">{</span><span class="n">BOT_NAME</span><span class="si">}</span><span class="s1">&quot;</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;api_key&#39;</span><span class="p">:</span> <span class="n">API_KEY</span><span class="p">}</span>
    
    <span class="n">url</span> <span class="o">=</span> <span class="n">BASE_URL</span> <span class="o">+</span> <span class="n">filename</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">. Status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="c1">#Unzip</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
    <span class="n">unzip_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;unzip -o </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">unzip_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">base_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># 去除.zip后缀</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span><span class="n">filename</span><span class="p">))</span>

    <span class="n">tns_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span><span class="n">base_filename</span><span class="p">),</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span><span class="n">header_start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_start</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tns_table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span><span class="n">base_filename</span><span class="p">),</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tns_table</span></div>

    


<div class="viewcode-block" id="get_Alerce">
<a class="viewcode-back" href="../../api.html#SOCS_Xray.fetch.get_Alerce">[docs]</a>
<span class="k">def</span> <span class="nf">get_Alerce</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>
<span class="sd">        query (str): Alerce query</span>

<span class="sd">    Returns:</span>
<span class="sd">        Table: Table of filtered alerts</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/alercebroker/usecases/master/alercereaduser_v4.json&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;postgresql+psycopg2://</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;dbname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
    <span class="n">alerce_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">alerce_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">alerce_table</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">alerce_table</span></div>



<div class="viewcode-block" id="get_Lasair">
<a class="viewcode-back" href="../../api.html#SOCS_Xray.fetch.get_Lasair">[docs]</a>
<span class="k">def</span> <span class="nf">get_Lasair</span><span class="p">(</span><span class="n">ndays</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>
<span class="sd">        ndays (int): How many days to look back.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Table: Table of filtered alerts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;API_ztf&#39;</span><span class="p">)</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;https://lasair-ztf.lsst.ac.uk/api&quot;</span>
    <span class="n">API_TOKEN</span> <span class="o">=</span> <span class="s1">&#39;cc411e15090ab35754f0d3673ddb4ceb671ee8cf&#39;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">lasair</span><span class="p">(</span><span class="n">API_TOKEN</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">)</span>
    
    <span class="n">rows</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;objects.objectId,</span>
<span class="s2">        objects.ramean,</span>
<span class="s2">        objects.decmean,</span>
<span class="s2">        objects.jdmin - 2400000.5 AS mjdmin,</span>
<span class="s2">        objects.jdmax - 2400000.5 AS mjdmax,</span>
<span class="s2">        objects.magrmin,</span>
<span class="s2">        objects.ncandgp AS ndet,</span>
<span class="s2">        objects.rmag,</span>
<span class="s2">        sherlock_classifications.classification AS classification&quot;&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;objects,</span>
<span class="sd">                sherlock_classifications,</span>
<span class="sd">                watchlist_hits,</span>
<span class="sd">                crossmatch_tns&quot;&quot;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;objects.objectId = sherlock_classifications.objectId</span>
<span class="sd">                AND objects.objectId = watchlist_hits.objectId</span>
<span class="sd">                AND objects.jdmin &gt; jdnow() - %s</span>
<span class="sd">                AND NOT (</span>
<span class="sd">                    objects.distpsnr1 &lt; 2</span>
<span class="sd">                    AND objects.sgscore1 &gt; 0.49</span>
<span class="sd">                )</span>
<span class="sd">                AND classification in (&quot;SN&quot;,&quot;NT&quot;,&quot;ORPHAN&quot;)</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ndays</span><span class="p">),</span>
                <span class="n">limit</span><span class="o">=</span><span class="mf">1e4</span><span class="p">)</span>

    <span class="n">lasair_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">lasair_table</span><span class="p">[</span><span class="n">lasair_table</span><span class="p">[</span><span class="s1">&#39;ndet&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">lasair_table</span><span class="p">[</span><span class="s1">&#39;ndet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasair_table</span><span class="p">[</span><span class="s1">&#39;ndet&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">lasair_table</span></div>





<div class="viewcode-block" id="request_obs_time">
<a class="viewcode-back" href="../../api.html#SOCS_Xray.fetch.request_obs_time">[docs]</a>
<span class="k">def</span> <span class="nf">request_obs_time</span><span class="p">(</span><span class="n">EMAIL</span><span class="p">,</span><span class="n">PASSWORD</span><span class="p">,</span><span class="n">ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>

<span class="sd">    Args:</span>
<span class="sd">        EMAIL (str): user email</span>
<span class="sd">        PASSWORD (str): password</span>
<span class="sd">        ids (list): source ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: list observation time</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EMAIL</span> <span class="o">=</span> <span class="s2">&quot;liangrd@bao.ac.cn&quot;</span> <span class="c1"># your login email in EP TDAIC</span>
    <span class="n">PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;Liang981127&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://ep.bao.ac.cn/ep/api/get_tokenp&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">EMAIL</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">PASSWORD</span><span class="p">},</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  
    <span class="n">token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">)</span> 

    <span class="n">obs_time</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="n">api_url</span> <span class="o">=</span> <span class="s2">&quot;https://ep.bao.ac.cn/ep/data_center/get_first_obs_date?source_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">id</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">api_url</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tdic-token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">},</span>  
                        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span><span class="n">token</span><span class="p">}</span> <span class="c1">#both hearders and params are need</span>
                    <span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">obs_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;first_obs_date&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">obs_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;2050-01-01T00:00:00Z&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fail on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">id</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">obs_time</span></div>



<div class="viewcode-block" id="base_alerce_query">
<a class="viewcode-back" href="../../api.html#SOCS_Xray.fetch.base_alerce_query">[docs]</a>
<span class="k">def</span> <span class="nf">base_alerce_query</span><span class="p">(</span><span class="n">ndet</span><span class="p">,</span><span class="n">mjdfirst</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SN&quot;</span><span class="p">,</span> <span class="s2">&quot;AGN&quot;</span><span class="p">],</span><span class="n">classifier</span><span class="o">=</span><span class="s1">&#39;stamp_classifier&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>
<span class="sd">        ndet (float): number of detections</span>
<span class="sd">        mjdfirst (float): first detection MJD</span>
<span class="sd">        types (list, optional): Classification. Defaults to [&quot;SN&quot;, &quot;AGN&quot;].</span>
<span class="sd">        classifier (str, optional): Classifier name. Defaults to &#39;stamp_classifier&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Alerce query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">ndet</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ndet</span> <span class="o">=</span> <span class="s1">&#39;&lt;2&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ndet</span> <span class="o">=</span> <span class="s1">&#39;&gt;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ndet</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        SELECT</span>
<span class="s1">            object.oid, object.meanra, object.meandec, object.firstmjd,</span>
<span class="s1">            object.ndet, object.stellar, probability.probability, </span>
<span class="s1">            probability.classifier_name, probability.classifier_version,</span>
<span class="s1">            probability.class_name</span>
<span class="s1">        FROM </span>
<span class="s1">            object </span>
<span class="s1">        INNER JOIN</span>
<span class="s1">            probability</span>
<span class="s1">        ON </span>
<span class="s1">            object.oid = probability.oid</span>
<span class="s1">        WHERE</span>
<span class="s1">            object.firstMJD &gt; </span><span class="si">%s</span>
<span class="s1">            AND probability.classifier_name = &#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
<span class="s1">            AND probability.class_name IN (</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">            AND probability.ranking=1</span>
<span class="s1">            AND probability.probability&gt;0.3</span>
<span class="s1">            AND object.ndet </span><span class="si">%s</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">mjdfirst</span><span class="p">,</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">types</span><span class="p">]),</span><span class="n">ndet</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">query</span></div>



<div class="viewcode-block" id="search_TNS">
<a class="viewcode-back" href="../../api.html#SOCS_Xray.fetch.search_TNS">[docs]</a>
<span class="k">def</span> <span class="nf">search_TNS</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="n">user_name</span><span class="p">,</span><span class="n">url_parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;discovered_period_value&quot;</span> <span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;discovered_period_units&quot;</span> <span class="p">:</span> <span class="s2">&quot;days&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;format&quot;</span> <span class="p">:</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;num_page&quot;</span> <span class="p">:</span> <span class="s2">&quot;200&quot;</span><span class="p">,},</span><span class="n">save_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>
<span class="sd">        user_id (str): ID</span>
<span class="sd">        user_name (str): Usr Name</span>
<span class="sd">        url_parameters (dict, optional): url parameters. Defaults to {&quot;discovered_period_value&quot; : &quot;10&quot;, &quot;discovered_period_units&quot; : &quot;days&quot;, &quot;format&quot; : &quot;csv&quot;, &quot;num_page&quot; : &quot;200&quot;,}.</span>
<span class="sd">        save_dir (str, optional): saving path. Defaults to &#39;./&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Table: Table of filtered TNS objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">TNS</span>                  <span class="o">=</span> <span class="s2">&quot;www.wis-tns.org&quot;</span>
    <span class="n">url_tns_search</span>       <span class="o">=</span> <span class="s2">&quot;https://&quot;</span> <span class="o">+</span> <span class="n">TNS</span> <span class="o">+</span> <span class="s2">&quot;/search&quot;</span>
    <span class="n">TNS_UID</span>              <span class="o">=</span> <span class="n">user_id</span>
    <span class="n">TNS_USER_NAME</span>        <span class="o">=</span> <span class="n">user_name</span>
    <span class="n">USER_OR_BOT</span>          <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">MERGE_TO_SINGLE_FILE</span>  <span class="o">=</span> <span class="mi">1</span>

    <span class="n">ext_http_errors</span>       <span class="o">=</span> <span class="p">[</span><span class="mi">403</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">503</span><span class="p">]</span>
    <span class="n">err_msg</span>               <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Forbidden&quot;</span><span class="p">,</span> <span class="s2">&quot;Internal Server Error: Something is broken&quot;</span><span class="p">,</span> <span class="s2">&quot;Service Unavailable&quot;</span><span class="p">]</span>

    <span class="c1">#----------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">set_user_tns_marker</span><span class="p">():</span>
        <span class="n">tns_marker</span> <span class="o">=</span> <span class="s1">&#39;tns_marker{&quot;tns_id&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">TNS_UID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;type&quot;: &quot;user&quot;, &quot;name&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="n">TNS_USER_NAME</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span>
        <span class="k">return</span> <span class="n">tns_marker</span>

    <span class="k">def</span> <span class="nf">is_string_json</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json_object</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">json_object</span>

    <span class="k">def</span> <span class="nf">response_status</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="n">json_string</span> <span class="o">=</span> <span class="n">is_string_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">json_string</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;[ &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_string</span><span class="p">[</span><span class="s1">&#39;id_code&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; - &#39;&quot;</span> <span class="o">+</span> <span class="n">json_string</span><span class="p">[</span><span class="s1">&#39;id_message&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39; ]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
            <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">status_msg</span> <span class="o">=</span> <span class="s1">&#39;OK&#39;</span>
            <span class="k">elif</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="n">ext_http_errors</span><span class="p">:</span>
                <span class="n">status_msg</span> <span class="o">=</span> <span class="n">err_msg</span><span class="p">[</span><span class="n">ext_http_errors</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">status_code</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status_msg</span> <span class="o">=</span> <span class="s1">&#39;Undocumented error&#39;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;[ &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &#39;&quot;</span> <span class="o">+</span> <span class="n">status_msg</span> <span class="o">+</span> <span class="s2">&quot;&#39; ]&quot;</span>
        <span class="k">return</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">print_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">page_num</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">response_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>     
            <span class="n">stats</span> <span class="o">=</span> <span class="s1">&#39;Page number &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; | return code: &#39;</span> <span class="o">+</span> <span class="n">status</span> <span class="o">+</span> \
                    <span class="s1">&#39; | Total Rate-Limit: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-rate-limit-limit&#39;</span><span class="p">))</span> <span class="o">+</span> \
                    <span class="s1">&#39; | Remaining: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-rate-limit-remaining&#39;</span><span class="p">))</span> <span class="o">+</span> \
                    <span class="s1">&#39; | Reset: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-rate-limit-reset&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>       
            <span class="n">stats</span> <span class="o">=</span> <span class="s1">&#39;Page number &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; | return code: &#39;</span> <span class="o">+</span> <span class="n">status</span>        
        <span class="nb">print</span> <span class="p">(</span><span class="n">stats</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_reset_time</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="c1"># If any of the &#39;...-remaining&#39; values is zero, return the reset time</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;-remaining&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;remaining&#39;</span><span class="p">,</span> <span class="s1">&#39;reset&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="kc">None</span>        

    <span class="c1"># function for searching TNS with specified url parameters</span>
    <span class="k">def</span> <span class="nf">search_tns</span><span class="p">():</span>
        <span class="c1">#--------------------------------------------------------------------</span>
        <span class="c1"># extract keywords and values from url parameters</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">url_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">url_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1">#--------------------------------------------------------------------</span>
        <span class="c1"># flag for checking if url is with correct keywords</span>
        <span class="n">wrong_url</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># check if keywords are correct</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">keywords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">URL_PARAMETERS</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Unknown url keyword &#39;&quot;</span><span class="o">+</span><span class="n">keywords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">wrong_url</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># check flag</span>
        <span class="k">if</span> <span class="n">wrong_url</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;TNS search url is not in the correct format.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1">#--------------------------------------------------------------------</span>
        <span class="c1"># else, if everything is correct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># current date and time</span>
            <span class="n">current_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">current_date_time</span> <span class="o">=</span> <span class="n">current_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
            <span class="c1"># current working directory</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">save_dir</span>       
            <span class="c1"># create searched results folder</span>
            <span class="k">if</span> <span class="n">MERGE_TO_SINGLE_FILE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tns_search_folder</span> <span class="o">=</span> <span class="s2">&quot;tns_search_data_&quot;</span> <span class="o">+</span> <span class="n">current_date_time</span>
                <span class="n">tns_search_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">tns_search_folder</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tns_search_folder_path</span><span class="p">)</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;TNS searched data folder /&quot;</span> <span class="o">+</span> <span class="n">tns_search_folder</span> <span class="o">+</span> <span class="s2">&quot;/ is successfully created.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>            
            <span class="c1"># file containing searched data</span>
            <span class="k">if</span> <span class="s2">&quot;format&quot;</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">url_parameters</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">tns_search_file</span> <span class="o">=</span> <span class="s2">&quot;tns_search_data&quot;</span> <span class="o">+</span> <span class="n">extension</span>
            <span class="n">tns_search_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">tns_search_file</span><span class="p">)</span>
            <span class="c1">#--------------------------------------------------------------------</span>
            <span class="c1"># build TNS search url</span>
            <span class="n">url_par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">values</span><span class="p">)]</span>
            <span class="n">tns_search_url</span> <span class="o">=</span> <span class="n">url_tns_search</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url_par</span><span class="p">)</span>
            <span class="c1">#--------------------------------------------------------------------</span>
            <span class="c1"># page number</span>
            <span class="n">page_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># searched data</span>
            <span class="n">searched_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># go trough every page</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># url for download</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">tns_search_url</span> <span class="o">+</span> <span class="s2">&quot;&amp;page=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_num</span><span class="p">)</span>
                <span class="c1"># TNS marker !!!only user!!!</span>
                <span class="n">tns_marker</span> <span class="o">=</span> <span class="n">set_user_tns_marker</span><span class="p">()</span>
                <span class="c1"># headers</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">tns_marker</span><span class="p">}</span>
                <span class="c1"># downloading file using request module</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># chek if response status code is not 200, or if returned data is empty</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">((</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Sending download search request for page num &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
                        <span class="n">print_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">page_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">break</span>            
                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Sending download search request for page num &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
                <span class="c1"># print status code of the response</span>
                <span class="n">print_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">page_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># get data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="c1"># create file per page</span>
                <span class="k">if</span> <span class="n">MERGE_TO_SINGLE_FILE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tns_search_f</span> <span class="o">=</span> <span class="s2">&quot;tns_search_data_&quot;</span> <span class="o">+</span> <span class="n">current_date_time</span> <span class="o">+</span> <span class="s2">&quot;_part_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">extension</span>
                    <span class="n">tns_search_f_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tns_search_folder_path</span><span class="p">,</span> <span class="n">tns_search_f</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tns_search_f_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;File &#39;&quot;</span> <span class="o">+</span> <span class="n">tns_search_f</span> <span class="o">+</span> <span class="s2">&quot;&#39; (containing &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; rows) is successfully created.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                     
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;File &#39;&quot;</span> <span class="o">+</span> <span class="n">tns_search_f</span> <span class="o">+</span> <span class="s2">&quot;&#39; (containing 1 row) is successfully created.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># add to searched data</span>
                <span class="k">if</span> <span class="n">page_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">searched_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">searched_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">])</span>
                <span class="c1"># check reset time</span>
                <span class="n">reset</span> <span class="o">=</span> <span class="n">get_reset_time</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reset</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Sleeping for reset + 1 sec</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sleep for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">reset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; sec and then continue...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">reset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># increase page num</span>
                <span class="n">page_num</span> <span class="o">=</span> <span class="n">page_num</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1">#--------------------------------------------------------------------</span>
            <span class="c1"># if there is searched data, write to file</span>
            <span class="k">if</span> <span class="n">searched_data</span> <span class="o">!=</span> <span class="p">[]:</span>            
                <span class="n">searched_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">searched_data</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>            
                <span class="k">if</span> <span class="n">MERGE_TO_SINGLE_FILE</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tns_search_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">searched_data</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">searched_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TNS searched data returned &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">searched_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; rows. File &#39;&quot;</span> <span class="o">+</span> \
                            <span class="n">tns_search_file</span> <span class="o">+</span> <span class="s2">&quot;&#39; is successfully created.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TNS searched data returned 1 row. File &#39;&quot;</span> <span class="o">+</span> <span class="n">tns_search_file</span> <span class="o">+</span> <span class="s2">&quot;&#39; is successfully created.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>            
                <span class="k">else</span><span class="p">:</span>                
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">searched_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;TNS searched data returned &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">searched_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; rows in total.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;TNS searched data returned 1 row in total.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">MERGE_TO_SINGLE_FILE</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;TNS searched data returned empty list. No file(s) created.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># remove empty folder</span>
                <span class="k">if</span> <span class="n">MERGE_TO_SINGLE_FILE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">tns_search_folder_path</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Folder /&quot;</span> <span class="o">+</span> <span class="n">tns_search_folder</span> <span class="o">+</span> <span class="s2">&quot;/ is removed.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tns_search_file_path</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">search_tns</span><span class="p">()</span></div>



<span class="n">URL_PARAMETERS</span>       <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;discovered_period_value&quot;</span><span class="p">,</span> <span class="s2">&quot;discovered_period_units&quot;</span><span class="p">,</span> <span class="s2">&quot;unclassified_at&quot;</span><span class="p">,</span> <span class="s2">&quot;classified_sne&quot;</span><span class="p">,</span> <span class="s2">&quot;include_frb&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;name_like&quot;</span><span class="p">,</span> <span class="s2">&quot;isTNS_AT&quot;</span><span class="p">,</span> <span class="s2">&quot;public&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;decl&quot;</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="s2">&quot;coords_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;reporting_groupid[]&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;groupid[]&quot;</span><span class="p">,</span> <span class="s2">&quot;classifier_groupid[]&quot;</span><span class="p">,</span> <span class="s2">&quot;objtype[]&quot;</span><span class="p">,</span> <span class="s2">&quot;at_type[]&quot;</span><span class="p">,</span> <span class="s2">&quot;date_start[date]&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;date_end[date]&quot;</span><span class="p">,</span>  <span class="s2">&quot;discovery_mag_min&quot;</span><span class="p">,</span> <span class="s2">&quot;discovery_mag_max&quot;</span><span class="p">,</span> <span class="s2">&quot;internal_name&quot;</span><span class="p">,</span> <span class="s2">&quot;discoverer&quot;</span><span class="p">,</span> <span class="s2">&quot;classifier&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;spectra_count&quot;</span><span class="p">,</span> <span class="s2">&quot;redshift_min&quot;</span><span class="p">,</span> <span class="s2">&quot;redshift_max&quot;</span><span class="p">,</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span> <span class="s2">&quot;ext_catid&quot;</span><span class="p">,</span> <span class="s2">&quot;ra_range_min&quot;</span><span class="p">,</span> <span class="s2">&quot;ra_range_max&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;decl_range_min&quot;</span><span class="p">,</span> <span class="s2">&quot;decl_range_max&quot;</span><span class="p">,</span> <span class="s2">&quot;discovery_instrument[]&quot;</span><span class="p">,</span> <span class="s2">&quot;classification_instrument[]&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;associated_groups[]&quot;</span><span class="p">,</span> <span class="s2">&quot;official_discovery&quot;</span><span class="p">,</span> <span class="s2">&quot;official_classification&quot;</span><span class="p">,</span> <span class="s2">&quot;at_rep_remarks&quot;</span><span class="p">,</span> <span class="s2">&quot;class_rep_remarks&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;frb_repeat&quot;</span><span class="p">,</span> <span class="s2">&quot;frb_repeater_of_objid&quot;</span><span class="p">,</span> <span class="s2">&quot;frb_measured_redshift&quot;</span><span class="p">,</span> <span class="s2">&quot;frb_dm_range_min&quot;</span><span class="p">,</span> <span class="s2">&quot;frb_dm_range_max&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;frb_rm_range_min&quot;</span><span class="p">,</span> <span class="s2">&quot;frb_rm_range_max&quot;</span><span class="p">,</span> <span class="s2">&quot;frb_snr_range_min&quot;</span><span class="p">,</span> <span class="s2">&quot;frb_snr_range_max&quot;</span><span class="p">,</span> <span class="s2">&quot;frb_flux_range_min&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;frb_flux_range_max&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;num_page&quot;</span><span class="p">]</span>





<div class="viewcode-block" id="download_fxt_data">
<a class="viewcode-back" href="../../api.html#SOCS_Xray.fetch.download_fxt_data">[docs]</a>
<span class="k">def</span> <span class="nf">download_fxt_data</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">ra</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">dec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">start_time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">end_time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">destination_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                     <span class="n">headless</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">state_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ep_oauth_state.json&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download Einstein Probe FXT observation data for given coordinates and time range.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    username : str</span>
<span class="sd">        EP account username.</span>
<span class="sd">    password : str</span>
<span class="sd">        EP account password.</span>
<span class="sd">    ra : float</span>
<span class="sd">        Target right ascension (deg).</span>
<span class="sd">    dec : float</span>
<span class="sd">        Target declination (deg).</span>
<span class="sd">    start_time : str</span>
<span class="sd">        Start time in &quot;YYYY-MM-DD HH:MM:SS&quot; format.</span>
<span class="sd">    end_time : str</span>
<span class="sd">        End time in &quot;YYYY-MM-DD HH:MM:SS&quot; format.</span>
<span class="sd">    destination_path : str</span>
<span class="sd">        Directory where data will be saved.</span>
<span class="sd">    radius : str, optional</span>
<span class="sd">        Search radius in degrees. Default = 0.01.</span>
<span class="sd">    headless : bool, optional</span>
<span class="sd">        Run browser in headless mode (default True).</span>
<span class="sd">    state_path : str, optional</span>
<span class="sd">        Path to save the Playwright state for login persistence.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ====== internal constants ======</span>
    <span class="n">PROTECTED_URL</span> <span class="o">=</span> <span class="s2">&quot;https://ep.bao.ac.cn/ep/data_center/fxt_obs/&quot;</span>
    <span class="n">API_URL</span> <span class="o">=</span> <span class="s2">&quot;https://ep.bao.ac.cn/ep/data_center/fxt_obs/api/&quot;</span>
    
    <span class="n">PER_PAGE_TIMEOUT</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="n">ASYNC_MAX_WAIT</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="n">RETRY_TIMES</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">destination_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">destination_path</span><span class="p">)</span>
    <span class="n">destination_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># ====== internal helper functions ======</span>
    <span class="k">def</span> <span class="nf">_mkrow_dir</span><span class="p">(</span><span class="n">destination_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">obs_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">detnam</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">destination_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">detnam</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">d</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_wait_async_link</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">page</span><span class="o">.</span><span class="n">get_by_role</span><span class="p">(</span><span class="s2">&quot;button&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Download User data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
        <span class="n">page</span><span class="o">.</span><span class="n">wait_for_selector</span><span class="p">(</span><span class="s2">&quot;#async-download-status&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;visible&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30_000</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">ASYNC_MAX_WAIT</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span><span class="o">.</span><span class="n">wait_for_function</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;() =&gt; {</span>
<span class="sd">                        const box = document.querySelector(&#39;#async-download-link&#39;);</span>
<span class="sd">                        const a = box ? box.querySelector(&#39;a&#39;) : null;</span>
<span class="sd">                        return box &amp;&amp; getComputedStyle(box).display !== &#39;none&#39; &amp;&amp; a &amp;&amp; a.href;</span>
<span class="sd">                    }&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">5_000</span>
                <span class="p">)</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">eval_on_selector</span><span class="p">(</span><span class="s2">&quot;#async-download-link a&quot;</span><span class="p">,</span> <span class="s2">&quot;el =&gt; el.href&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">href</span>
            <span class="k">except</span> <span class="n">PWTimeout</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_download_user_zip</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">obs_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">detnam</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">detnam</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">_user.zip&quot;</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [skip] user zip exists: </span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">target</span>
        <span class="n">href</span> <span class="o">=</span> <span class="n">_wait_async_link</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">href</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Async user-data link did not appear within time limit.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">page</span><span class="o">.</span><span class="n">expect_download</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">PER_PAGE_TIMEOUT</span><span class="p">)</span> <span class="k">as</span> <span class="n">dl_info</span><span class="p">:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">click</span><span class="p">(</span><span class="s2">&quot;#async-download-link a&quot;</span><span class="p">)</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">dl_info</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dl</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [ok] user zip -&gt; </span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">target</span>

    <span class="k">def</span> <span class="nf">_download_sources_csv</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">obs_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">detnam</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">detnam</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">_sources.csv&quot;</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [skip] sources csv exists: </span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">target</span>
        <span class="n">page</span><span class="o">.</span><span class="n">wait_for_selector</span><span class="p">(</span><span class="s2">&quot;#download_src&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30_000</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">page</span><span class="o">.</span><span class="n">expect_download</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">PER_PAGE_TIMEOUT</span><span class="p">)</span> <span class="k">as</span> <span class="n">dl_info</span><span class="p">:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">click</span><span class="p">(</span><span class="s2">&quot;#download_src&quot;</span><span class="p">)</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">dl_info</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dl</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [ok] sources csv -&gt; </span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">target</span>

    <span class="k">def</span> <span class="nf">_process_one_row</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">obs_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;obs_id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">detnam</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;detnam&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;02&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://ep.bao.ac.cn/ep/data_center/fxt_obs_detail/</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">detnam</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">==&gt; </span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">detnam</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">wait_until</span><span class="o">=</span><span class="s2">&quot;domcontentloaded&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">PER_PAGE_TIMEOUT</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">wait_for_selector</span><span class="p">(</span><span class="s2">&quot;text=Get Data Files&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30_000</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">wait_for_selector</span><span class="p">(</span><span class="s2">&quot;text=Sources in the observation&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30_000</span><span class="p">)</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">_mkrow_dir</span><span class="p">(</span><span class="n">destination_path</span><span class="p">,</span> <span class="n">obs_id</span><span class="p">,</span> <span class="n">detnam</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_download_user_zip</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">obs_id</span><span class="p">,</span> <span class="n">detnam</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [warn] user zip failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_download_sources_csv</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">obs_id</span><span class="p">,</span> <span class="n">detnam</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [warn] sources csv failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_batch</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">sync_playwright</span><span class="p">()</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">browser</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">chromium</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">new_context</span><span class="p">(</span><span class="n">storage_state</span><span class="o">=</span><span class="n">state_path</span><span class="p">,</span> <span class="n">accept_downloads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">RETRY_TIMES</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_process_one_row</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [err] row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;=</span> <span class="n">RETRY_TIMES</span><span class="p">:</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  [give up] move on.&quot;</span><span class="p">)</span>
            <span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">sync_playwright</span><span class="p">()</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">browser</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">chromium</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">new_context</span><span class="p">()</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>
            <span class="n">page</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="n">PROTECTED_URL</span><span class="p">,</span> <span class="n">wait_until</span><span class="o">=</span><span class="s2">&quot;domcontentloaded&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;oauth.china-vo.org&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">storage_state</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">state_path</span><span class="p">)</span>
                <span class="n">cookies</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">cookies</span><span class="p">()</span>
                <span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cookies</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;domain&quot;</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">s</span>
            <span class="n">page</span><span class="o">.</span><span class="n">wait_for_selector</span><span class="p">(</span><span class="s1">&#39;input[name=&quot;username&quot;]&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60_000</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s1">&#39;input[name=&quot;username&quot;]&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s1">&#39;input[name=&quot;password&quot;]&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_visible</span><span class="p">(</span><span class="s1">&#39;input[name=&quot;captcha&quot;]&#39;</span><span class="p">):</span>
                <span class="n">page</span><span class="o">.</span><span class="n">screenshot</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;login_need_captcha.png&quot;</span><span class="p">)</span>
                <span class="n">code</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;验证码出现，请查看 login_need_captcha.png 并输入: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">page</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s1">&#39;input[name=&quot;captcha&quot;]&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">get_by_role</span><span class="p">(</span><span class="s2">&quot;button&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">))</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span><span class="o">.</span><span class="n">wait_for_url</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^https://ep\.bao\.ac\.cn/.*&quot;</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60_000</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">PWTimeout</span><span class="p">:</span>
                <span class="n">page</span><span class="o">.</span><span class="n">wait_for_selector</span><span class="p">(</span><span class="s1">&#39;a[href=&quot;/ep/user/logout&quot;], img.avatar-xs, text=My Home&#39;</span><span class="p">,</span>
                                       <span class="n">timeout</span><span class="o">=</span><span class="mi">60_000</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">storage_state</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">state_path</span><span class="p">)</span>
            <span class="n">cookies</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">cookies</span><span class="p">()</span>
            <span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cookies</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">domain</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;domain&quot;</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="c1"># ====== main logic ======</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">_login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;obs_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_datetime&quot;</span><span class="p">:</span> <span class="n">start_time</span><span class="p">,</span>
        <span class="s2">&quot;end_datetime&quot;</span><span class="p">:</span> <span class="n">end_time</span><span class="p">,</span>
        <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="n">ra</span><span class="p">,</span>
        <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="n">dec</span><span class="p">,</span>
        <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;obs_start&quot;</span><span class="p">,</span> <span class="s2">&quot;detnam&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">destination_path</span> <span class="o">/</span> <span class="s2">&quot;fxt_obs_list.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8-sig&quot;</span><span class="p">)</span>
        <span class="n">_run_batch</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ All downloads completed.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ No matching observations found.&quot;</span><span class="p">)</span></div>



<span class="kn">import</span> <span class="nn">pexpect</span>

<div class="viewcode-block" id="download_wxt_data">
<a class="viewcode-back" href="../../api.html#SOCS_Xray.fetch.download_wxt_data">[docs]</a>
<span class="k">def</span> <span class="nf">download_wxt_data</span><span class="p">(</span><span class="n">username</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">ra</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">dec</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;101.201.57.201&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download WXT level 2-3 data.</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str): user name</span>
<span class="sd">        password (str): pasword</span>
<span class="sd">        local_path (str): local path to store data</span>
<span class="sd">        start_time (str): start observation time for searching</span>
<span class="sd">        end_time (str): end observation time for searching</span>
<span class="sd">        ra (float): RA in degree</span>
<span class="sd">        dec (float): Dec in degree</span>
<span class="sd">        radius (float, optional): cone searhing radius in degree. Defaults to 0.05.</span>
<span class="sd">        host (str, optional): host ip. Defaults to &#39;101.201.57.201&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">_scp_download</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="n">remote_path</span><span class="p">,</span><span class="n">local_path</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;scp </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⬇️ Running: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">child</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s1">&#39;password:&#39;</span><span class="p">,</span> <span class="s1">&#39;continue connecting (yes/no)?&#39;</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># First-time connection confirmation</span>
            <span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;password:&#39;</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Password prompt</span>
            <span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

        <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ File downloaded successfully!&quot;</span><span class="p">)</span>
    
    <span class="c1">#Request Obs ID Data</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://ep.bao.ac.cn/ep/data_center/api/wxt_observation_data/&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="n">ra</span><span class="p">,</span>
        <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="n">dec</span><span class="p">,</span>
        <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="n">radius</span><span class="p">,</span>
        <span class="s2">&quot;start_datetime&quot;</span><span class="p">:</span> <span class="n">start_time</span><span class="p">,</span>
        <span class="s2">&quot;end_datetime&quot;</span><span class="p">:</span> <span class="n">end_time</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Status code</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
    
    
    <span class="c1">#SCP from server</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">obsid</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]</span>
        <span class="n">cmosid</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;detnam&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
        <span class="c1"># print((data[i][&#39;pnt_ra&#39;],data[i][&#39;pnt_dec&#39;]))</span>
        <span class="n">local_path_i</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span><span class="n">obsid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path_i</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">local_path_i</span><span class="p">)</span>
        <span class="n">clevtfile</span> <span class="o">=</span> <span class="s1">&#39;/mnt/epdata_pipeline/L23/obs/</span><span class="si">%s</span><span class="s1">/ep</span><span class="si">%s</span><span class="s1">wxt</span><span class="si">%s</span><span class="s1">po_cl.evt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span><span class="n">obsid</span><span class="p">,</span><span class="n">cmosid</span><span class="p">)</span>
        <span class="c1"># arffile = &#39;/mnt/epdata_pipeline/L23/obs/%s/ep%swxt%spo_uf.evt&#39;%(obsid,obsid,cmosid)</span>
        <span class="n">rmffile</span> <span class="o">=</span> <span class="s1">&#39;/mnt/wxt_fm_caldb/caldb/data/ep/wxt/cpf/rmf/epw</span><span class="si">%s</span><span class="s1">_0to12_20231230v001.rmf&#39;</span><span class="o">%</span><span class="n">cmosid</span>
        <span class="n">arffile</span> <span class="o">=</span> <span class="s1">&#39;/mnt/epdata_pipeline/L23/obs/</span><span class="si">%s</span><span class="s1">/ep</span><span class="si">%s</span><span class="s1">wxt</span><span class="si">%s</span><span class="s1">s1.arf&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span><span class="n">obsid</span><span class="p">,</span><span class="n">cmosid</span><span class="p">)</span> <span class="c1">#default using s1 for approximation</span>
        <span class="n">_scp_download</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="n">local_path</span><span class="o">=</span><span class="n">local_path_i</span><span class="p">,</span><span class="n">remote_path</span><span class="o">=</span><span class="n">clevtfile</span><span class="p">)</span>
        <span class="n">_scp_download</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="n">local_path</span><span class="o">=</span><span class="n">local_path_i</span><span class="p">,</span><span class="n">remote_path</span><span class="o">=</span><span class="n">arffile</span><span class="p">)</span>
        <span class="n">_scp_download</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="n">local_path</span><span class="o">=</span><span class="n">local_path_i</span><span class="p">,</span><span class="n">remote_path</span><span class="o">=</span><span class="n">rmffile</span><span class="p">)</span></div>

    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, R. D. Liang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>